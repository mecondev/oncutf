# Refactoring & Optimization Plan

**Date:** 2025-12-19 (Updated: 2025-12-20)  
**Author:** AI Assistant  
**Status:** IN PROGRESS — Phase 2 Complete

---

## 1. Executive Summary

This document outlines a comprehensive refactoring plan for the `oncutf` codebase. The codebase has already undergone significant restructuring — code now resides in the `oncutf/` package with organized subdirectories (`controllers/`, `core/`, `domain/`, `models/`, `modules/`, `services/`, `ui/`, `utils/`).

### Primary Goals
1. **Performance** — Reduce startup time, optimize metadata loading, enhance cache efficiency
2. **Code Clarity** — Split remaining oversized classes, improve separation of concerns
3. **GUI Stability** — Implement defensive programming, global error boundaries, thread safety

### Key Metrics

| File | Size | Lines (est.) | Issue |
|------|------|--------------|-------|
| `core/unified_metadata_manager.py` | 91KB | ~2,300 | Monolithic — handles reading, writing, caching |
| `core/event_handler_manager.py` | 63KB | ~1,600 | Handles all UI events — no domain separation |
| `ui/main_window.py` | 56KB | ~1,400 | Large but acceptable facade |
| `core/database_manager.py` | 54KB | ~1,400 | Complex — consider splitting |
| `core/unified_rename_engine.py` | 46KB | ~1,200 | Consider splitting by responsibility |

The `core/` directory still contains **64 files** — grouping by subdomain would improve maintainability.

---

## 2. Structural Refactoring

### 2.1 Split `core/` into Subdirectories

**Current State:** 64 files in flat structure  
**Proposed Structure:**

```
core/
├── cache/                    # Cache management
│   ├── advanced_cache_manager.py
│   ├── persistent_hash_cache.py
│   └── persistent_metadata_cache.py
├── database/                 # Database operations
│   ├── database_manager.py
│   └── optimized_database_manager.py
├── drag/                     # Drag & drop operations
│   ├── drag_cleanup_manager.py
│   ├── drag_manager.py
│   └── drag_visual_manager.py
├── events/                   # Event handling (split from event_handler_manager)
│   ├── file_event_handlers.py
│   ├── ui_event_handlers.py
│   └── context_menu_handlers.py
├── hash/                     # Hash operations
│   ├── hash_manager.py
│   ├── hash_operations_manager.py
│   ├── hash_worker.py
│   └── parallel_hash_worker.py
├── initialization/           # Startup logic
│   ├── initialization_manager.py
│   ├── initialization_orchestrator.py
│   └── initialization_worker.py
├── metadata/                 # Metadata operations (split from unified_metadata_manager)
│   ├── metadata_reader.py
│   ├── metadata_writer.py
│   ├── metadata_cache_service.py
│   └── companion_handler.py
├── rename/                   # Rename operations
│   ├── rename_manager.py
│   ├── rename_history_manager.py
│   └── unified_rename_engine.py
├── selection/                # Selection management
│   ├── selection_manager.py
│   └── selection_store.py
└── ui_managers/              # UI-related managers
    ├── ui_manager.py
    ├── column_manager.py
    ├── splitter_manager.py
    └── status_manager.py
```

### 2.2 Split God Classes

#### 2.2.1 `unified_metadata_manager.py` (91KB) → 4 Modules ✅ COMPLETE

| New Module | Lines | Responsibility | Status |
|------------|-------|----------------|--------|
| `metadata_reader.py` | 289 | Load metadata from files using ExifTool | ✅ Done |
| `metadata_writer.py` | 266 | Write/update metadata to files | ✅ Done |
| `metadata_cache_service.py` | 120 | In-memory and persistent cache operations | ✅ Done |
| `companion_metadata_handler.py` | 237 | Handle sidecar/companion file metadata | ✅ Done |

**Location:** `oncutf/core/metadata/`

#### 2.2.2 `event_handler_manager.py` (63KB) → 3 Modules ✅ COMPLETE

| New Module | Lines | Responsibility | Status |
|------------|-------|----------------|--------|
| `file_event_handlers.py` | 94 | Browse, folder import, file operations | ✅ Done |
| `ui_event_handlers.py` | 154 | Header toggle, row clicks, double clicks | ✅ Done |
| `context_menu_handlers.py` | 1169 | Right-click menu logic, bulk rotation, analysis | ✅ Done |

**Location:** `oncutf/core/events/`  
**Facade:** `event_handler_manager.py` reduced from 1528 to 171 lines

---

## 3. Performance Optimization

### 3.1 Startup Time Reduction

**Actions:**
- [ ] Profile initialization to identify bottlenecks
- [ ] Lazy-load non-essential managers
- [ ] Defer database connection until first use
- [ ] Use `QTimer.singleShot(0, ...)` for non-critical post-startup tasks

### 3.2 ExifTool Batching

**Current State:** Uses `-stay_open` mode ✓  
**Improvements:**
- [ ] Verify batch size is optimal
- [ ] Add request coalescing for rapid successive calls
- [ ] Implement request prioritization (UI-blocking vs background)

### 3.3 Cache Strategy Review

**Files to audit:**
- `core/advanced_cache_manager.py`
- `core/persistent_metadata_cache.py`
- `utils/metadata_cache_helper.py`

**Actions:**
- [ ] Ensure L1 (memory) → L2 (disk) cache hierarchy
- [ ] Review cache invalidation logic
- [ ] Add cache hit/miss metrics logging for profiling

### 3.4 GUI Responsiveness

- [ ] Audit for long-running operations on main thread
- [ ] Verify signal debouncing on high-frequency signals
- [ ] Review `processEvents()` calls — can cause reentrancy bugs

---

## 4. GUI Error Reduction

### 4.1 Global Error Boundary

**Location:** `main.py`

**Implementation:**
```python
def global_exception_handler(exc_type, exc_value, exc_tb):
    logger.critical("Unhandled exception", exc_info=(exc_type, exc_value, exc_tb))
    # Show user-friendly notification instead of crashing
    # Attempt graceful recovery or offer restart
    
sys.excepthook = global_exception_handler
```

### 4.2 Defensive Widget Programming

**Pattern to enforce in `ui/widgets/`:**
```python
# Before (unsafe)
value = file_item.metadata.get("Date")

# After (safe)
value = getattr(file_item, 'metadata', {}).get("Date", "")
```

### 4.3 Qt Object Lifecycle

**Problem:** `RuntimeError: wrapped C/C++ object has been deleted`

**Solutions:**
- Use `QPointer` for potentially deleted objects
- Check `isValid()` / `is not None` before operations
- Use `deleteLater()` instead of `del` or `close()`

---

## 5. Implementation Roadmap

### Phase 1: Foundation ✅ COMPLETE
- ✅ Implement global error boundary in `main.py` (commit `751871b6`)
- ✅ Create subdirectory structure under `core/` — `core/metadata/` and `core/events/` created
- ✅ Run existing tests — all tests passing

**Commits:**
- `751871b6` - feat: add global exception handler for improved error handling

### Phase 2: Core Refactoring ✅ COMPLETE
- ✅ Split `unified_metadata_manager.py` into 4 modules (91KB → 4 modules in `core/metadata/`)
  - `metadata_reader.py` (289 lines) - Load metadata from files using ExifTool
  - `metadata_writer.py` (266 lines) - Write/update metadata to files  
  - `metadata_cache_service.py` (120 lines) - In-memory and persistent cache operations
  - `companion_metadata_handler.py` (237 lines) - Handle sidecar/companion file metadata
- ✅ Split `event_handler_manager.py` into 3 modules (1528 → 171 lines facade)
  - `file_event_handlers.py` (94 lines) - Browse, folder import handlers
  - `ui_event_handlers.py` (154 lines) - Header toggle, row clicks, double clicks
  - `context_menu_handlers.py` (1169 lines) - Right-click menu, bulk rotation, analysis
- ✅ Update all imports — backward compatibility maintained
- ✅ Run tests after each split — all passing
- ✅ Fix all linting issues (ruff, mypy)

**Commits:**
- `7a21f0e2` - feat: extract 3 modules from unified_metadata_manager (Phase 2 WIP)
- `30341766` - feat: Phase 2 integration - delegate cache methods to modules
- `4112921d` - feat: complete writer delegation (save methods + cancel)
- `7607b2b0` - feat: delegate companion methods to handler
- `ce4e3394` - Fix mypy: silence Qt attribute typing and untyped call
- `b9419edf` - fix: improve type annotations in metadata writer and companion handler
- `d4d9bf23` - Merge branch 'refactor/phase2-split-metadata-manager'
- `a372c382` - feat: split event_handler_manager into 3 modules (Phase 2)
- `cb87d805` - chore: fix all ruff linting errors

**Results:**
- `unified_metadata_manager.py`: 91KB → delegated to 4 modules (912 lines total)
- `event_handler_manager.py`: 1528 lines → 171 lines (facade only)
- Total reduction: ~1500 lines moved to specialized modules
- All tests passing (292 source files, 0 mypy errors, 0 ruff errors)

### Phase 3: Performance (Planned)
- [ ] Profile startup time
- [ ] Optimize cache strategy
- [ ] Add debouncing where missing

### Phase 4: Polish (Planned)
- [ ] Add defensive programming patterns
- [ ] Fix Qt object lifecycle issues
- [ ] Final testing and documentation

---

## 6. Verification Plan

### Automated Tests
```bash
# Run all tests
pytest tests/ -v

# Run with coverage
pytest tests/ --cov=oncutf --cov-report=term-missing
```

### Manual Verification
1. **Startup Test:** Application starts without errors in < 3 seconds
2. **File Loading:** Load 100+ files, verify no UI freezes
3. **Metadata Operations:** Load, edit, save metadata without crashes
4. **Drag & Drop:** All drag operations work smoothly
5. **Error Handling:** Force errors and verify graceful recovery

---

## 7. Success Metrics

| Metric | Current | Target |
|--------|---------|--------|
| Startup Time | Unknown | < 2s |
| Max Module Size | 91KB | < 30KB |
| Unhandled Exceptions | Unknown | 0 |
| Test Coverage | Unknown | > 80% |

---

## 8. Risk Assessment

| Risk | Mitigation |
|------|------------|
| Breaking existing functionality | Run tests after each change |
| Import cycle issues | Use lazy imports where needed |
| Performance regression | Profile before/after each phase |

---

## 9. Existing Test Infrastructure

**Test Location:** `tests/` (76 files)

```bash
# Verify existing tests still pass
pytest tests/ -v --tb=short
```

---

**Next Steps:** Review this plan and approve before proceeding to Phase 1.
