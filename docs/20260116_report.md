# Repository Audit Report: oncutf (Batch File Renamer GUI / PyQt5)

**Audit Date:** 2026-01-16  
**Auditor:** Senior Engineer / Code Auditor  
**Repository:** `/mnt/data_1/edu/Python/oncutf`  
**Project Version:** 1.3.0 (Python 3.12, PyQt5)

---

## Executive Summary

The oncutf codebase is a mature, well-structured PyQt5 desktop application for batch file renaming with EXIF metadata support. The architecture demonstrates good separation of concerns, proper dependency injection patterns, and comprehensive test coverage infrastructure. However, several issues warrant attention:

### Top Issues (P0/P1)
1. **Manager Class Proliferation** — 50+ Manager classes across codebase create excessive indirection
2. **Incomplete Module** — `backup_store.py` is a stub with only TODOs, no implementation
3. **Deprecated Shim Modules** — 6+ deprecation shims exist that should be removed post-v2.0 migration
4. **Exception Swallowing** — 50+ bare `except Exception:` blocks risk hiding errors
5. **Duplicate Hash Workers** — `hash_worker.py` (26KB) vs `parallel_hash_worker.py` (22KB) overlap significantly

### Top Wins
1. Clean service registry pattern (`services/registry.py`) enables testability
2. Proper controller/service separation with well-defined responsibilities
3. Tiered mypy configuration for gradual type safety adoption
4. Comprehensive shutdown coordination preventing resource leaks
5. Modular config system split by domain (app/ui/features/paths/columns)
6. Good test structure with 71+ test files covering core functionality

---

## Repository Map

```
oncutf/                     # Main package (421 items)
├── config/                 # Configuration modules (6 files + ui/ subpackage)
│   ├── app.py              # App info, debug flags, logging
│   ├── columns.py          # Table/tree column configurations
│   ├── features.py         # Feature flags, external tools, limits
│   ├── paths.py            # File paths, extensions, validation
│   ├── shortcuts.py        # Keyboard shortcuts
│   └── ui/                 # UI settings, themes, colors, fonts
│
├── controllers/            # High-level orchestration (9 controllers)
│   ├── main_window_controller.py   # Session/shutdown workflow orchestration
│   ├── file_load_controller.py     # File loading operations
│   ├── metadata_controller.py      # Metadata operations
│   ├── rename_controller.py        # Rename workflow orchestration
│   └── ui/                         # UI-specific controllers
│
├── core/                   # Core business logic (120 items, 14 subdirs)
│   ├── application_context.py      # Singleton app state hub
│   ├── application_service.py      # Facade for all operations
│   ├── shutdown_coordinator.py     # Graceful shutdown management
│   ├── thread_pool_manager.py      # Thread pool with SmartWorkerThread
│   ├── batch/              # Batch operations
│   ├── cache/              # Caching (advanced_cache_manager)
│   ├── database/           # SQLite stores (path, hash, metadata, session)
│   ├── drag/               # Drag-drop managers
│   ├── events/             # Event handling
│   ├── file/               # File operations (load, validate, stream)
│   ├── hash/               # Hash workers and managers
│   ├── initialization/     # App startup workers
│   ├── metadata/           # 27 files: loader, writer, cache, simplification
│   ├── rename/             # 10 files: engine, managers, history
│   ├── rename_graph/       # Graph-based rename (incomplete)
│   ├── selection/          # Selection store and manager
│   └── ui_managers/        # UI-specific managers
│
├── domain/                 # Domain models (minimal - 3 files)
│
├── models/                 # Data models (8 files + file_table/)
│   ├── file_item.py        # Core FileItem model
│   ├── metadata_entry.py   # Metadata representation
│   ├── validation_result.py # Rename validation
│   └── file_table/         # Table model components
│
├── modules/                # Rename operation modules (8 modules)
│   ├── counter_module.py
│   ├── metadata_module.py
│   ├── text_removal_module.py
│   ├── specified_text_module.py
│   └── ...
│
├── services/               # Service layer with DI (7 files)
│   ├── interfaces.py       # Protocol definitions
│   ├── registry.py         # ServiceRegistry for DI
│   └── *_service.py        # Concrete implementations
│
├── ui/                     # UI layer (181 items)
│   ├── main_window.py      # Minimal MainWindow shell
│   ├── main_window_delegates/  # 10 delegate classes
│   ├── behaviors/          # 31 behavior implementations
│   ├── dialogs/            # Custom dialogs
│   ├── handlers/           # Event handlers
│   ├── widgets/            # 115 widget files
│   └── services/           # UI service layer
│
└── utils/                  # Utilities (58 items)
    ├── filesystem/         # Path, file operations
    ├── logging/            # Logging setup
    ├── metadata/           # Metadata utilities
    ├── naming/             # Filename validation
    ├── shared/             # Shared utilities (config, timer, exiftool)
    └── ui/                 # UI helpers (DPI, icons, fonts)

tests/                      # Test suite (71 test files)
docs/                       # Documentation (26 markdown files)
scripts/                    # Utility scripts (26 files)
```

---

## High Priority Findings (P0/P1)

### P0-1: Incomplete Module — `backup_store.py` is Empty Stub

**Evidence:**
- **File:** `oncutf/core/database/backup_store.py`
- **Symbol:** `BackupStore` class
- **Pattern:** Class exists with `__init__` but only contains TODO comments, no implementation

```python
# Lines 35-40
# TODO: Extract rename_history methods from DatabaseManager:
# - store_rename_operation
# - get_rename_history
# - get_rename_operations_by_id
# - get_last_operation_id
# - clear_rename_history
```

**Impact:** The rename history functionality referenced by the TODO is presumably still in `DatabaseManager`, creating confusion about ownership and violating the stated composition architecture.

**Recommendation:** Either:
1. Complete the extraction of rename_history methods to `BackupStore`, OR
2. Remove `BackupStore` if extraction is deferred, OR
3. Document explicitly in `DatabaseManager` that rename_history will move

---

### P0-2: Unimplemented `rename_graph` Module

**Evidence:**
- **Files:** 
  - `oncutf/core/rename_graph/graph_model.py` (lines 152, 177)
  - `oncutf/core/rename_graph/graph_validator.py` (line 138)
  - `oncutf/controllers/rename_graph_controller.py` (lines 196, 212, 232, 255)

**Pattern:** Multiple `# TODO: Implement...` placeholders:
```python
# TODO: Implement proper cycle detection using DFS
# TODO: Implement proper topological sort
# TODO: Implement deserialization
# TODO: Implement module-to-graph conversion
# TODO: Implement graph-to-module conversion
# TODO: Implement node factory
# TODO: Implement edge creation
```

**Impact:** The entire `rename_graph` subsystem appears non-functional. If this is future work, it should be feature-flagged or isolated.

**Recommendation:** Either:
1. Remove `rename_graph/` if not needed, OR
2. Mark clearly as "experimental/future" with feature flag, OR
3. Complete implementation before v2.0

---

### P1-1: Exception Swallowing Risk

**Evidence:**
- **Count:** 50+ occurrences of bare `except Exception:` across codebase
- **Key Files:** 
  - `metadata_loader.py` (6 occurrences)
  - `metadata_writer.py` (5 occurrences)
  - `hash_loading_service.py` (3 occurrences)
  - `companion_metadata_handler.py` (4 occurrences)
  - `shutdown_coordinator.py` (2 occurrences)

**Pattern:**
```python
except Exception:
    # Silent catch with no logging or re-raise
    pass  # or just continue
```

**Impact:** Errors may be silently swallowed, making debugging difficult and potentially hiding data corruption or security issues.

**Recommendation:** Audit each `except Exception:` block:
- Add `logger.exception(...)` for debugging
- Consider more specific exception types
- Document intentional suppression with `# noqa` and comment

---

### P1-2: Manager Class Proliferation (50+)

**Evidence:** Found 50+ classes named `*Manager` via grep:

| Domain | Count | Examples |
|--------|-------|----------|
| `core/metadata/` | 7 | `UnifiedMetadataManager`, `MetadataCommandManager`, `MetadataOperationsManager`, `MetadataStagingManager`, `StructuredMetadataManager`, `SemanticAliasesManager`, `TreeModelBuilder` |
| `core/rename/` | 6 | `RenameManager`, `RenameStateManager`, `RenameHistoryManager`, `UnifiedPreviewManager`, `UnifiedValidationManager`, `UnifiedExecutionManager` |
| `core/ui_managers/` | 7 | `StatusManager`, `ShortcutManager`, `ColumnManager`, `SplitterManager`, `WindowConfigManager`, `TableManager`, `FileLoadUIService` |
| `core/hash/` | 3 | `HashManager`, `HashOperationsManager`, `HashResultsPresenter` |
| `core/file/` | 3 | `FileLoadManager`, `FileValidationManager`, `FileOperationsManager` |
| `core/drag/` | 3 | `DragManager`, `DragVisualManager`, `DragCleanupManager` |

**Impact:** 
- Deep call chains for simple operations
- Difficult to trace code flow
- Some managers appear to be thin wrappers (e.g., `HashOperationsManager` wraps `HashManager`)

**Recommendation:** Consider consolidation:
- Merge `HashManager` + `HashOperationsManager` + `HashResultsPresenter` into single `HashService`
- Merge `core/file/` managers into single `FileService`
- Group `core/ui_managers/` by feature rather than concern

---

## Duplicate Code & Consolidation Targets

### D-1: Hash Worker Duplication

**Files:**
- `oncutf/core/hash/hash_worker.py` (26KB, 700+ lines)
- `oncutf/core/hash/parallel_hash_worker.py` (22KB, 600+ lines)

**Evidence:** Both files:
- Use `QThread` for background hash calculation
- Have similar `HashWorker`/`ParallelHashWorker` class structures
- Implement cancellation, progress signals, batch processing
- Use `QMutex` for thread safety

**Consolidation:** Create a base `BaseHashWorker` with:
- Shared cancellation logic (already exists partially in `CancellableMixin`)
- Common progress reporting
- Unified batch processing interface

Estimated savings: ~400 lines of code

---

### D-2: Deprecated Shim Modules

**Files (6+ modules):**
1. `oncutf/ui/widgets/file_tree_view.py` (34 lines) — re-exports from `file_tree/`
2. `oncutf/ui/widgets/file_table_view.py` (23 lines) — re-exports from `file_table/`
3. `oncutf/ui/behaviors/selection_behavior.py` (23 lines) — re-exports from `selection/`
4. `oncutf/ui/behaviors/metadata_edit_behavior.py` (28 lines) — re-exports from `metadata_edit/`
5. `oncutf/ui/behaviors/metadata_context_menu_behavior.py` — re-exports from `metadata_context_menu/`
6. `oncutf/ui/behaviors/column_management_behavior.py` — re-exports from `column_management/`

**Pattern:** All emit `DeprecationWarning` and are marked for removal in v2.0.

**Recommendation:** 
1. Track all imports to these shims via `grep -r "from oncutf.ui.behaviors.selection_behavior"`
2. Update all imports to new locations
3. Delete shims in v2.0 release

---

### D-3: Service Interface Overlap

**Files:**
- `oncutf/services/hash_service.py` — HashService implementation
- `oncutf/core/hash/hash_manager.py` — HashManager implementation

**Evidence:** Both provide:
- `calculate_hash(file_path)` method
- Cache management
- Similar public interfaces

**Recommendation:** Ensure single source of truth:
- `HashService` should delegate entirely to `HashManager`, OR
- `HashManager` should be deprecated in favor of `HashService`

---

## Dead Code / Unused / Obsolete

### DC-1: `BackupStore` — Incomplete Placeholder

**File:** `oncutf/core/database/backup_store.py` (41 lines)

**Status:** Contains only TODO comments, no functional code beyond `__init__`.

**Verification:**
```bash
grep -r "BackupStore" oncutf/
# Only found in: database_manager.py (import), backup_store.py (definition)
```

**Recommendation:** Complete or remove.

---

### DC-2: Deprecated Function Decorators

**Files with `@deprecated` decorator:**
1. `oncutf/core/application_context.py:214` — `set_files()` method
2. `oncutf/ui/widgets/progress_widget.py:741` — `_format_time()` method (should use `_format_time_hms()`)
3. `oncutf/ui/delegates/color_column_delegate.py:285` — Old method
4. `oncutf/modules/text_removal_module.py:224-234` — Three deprecated signal connection methods

**Recommendation:** Track usage and remove deprecated methods in v2.0.

---

### DC-3: Potential Unused Imports (Requires `ruff` validation)

Run `ruff check --select F401` to identify unused imports automatically. Current configuration already includes this rule.

---

## Architecture & Boundaries

### A-1: Clean Patterns (Positive)

1. **Service Registry Pattern** (`oncutf/services/registry.py`):
   - Proper dependency injection using Protocol-based interfaces
   - `configure_default_services()` called at startup
   - Easy mocking for tests

2. **Controller/Service Separation**:
   - `MainWindowController` orchestrates workflows
   - `ApplicationService` acts as facade
   - Controllers don't contain business logic

3. **Tiered MyPy Configuration**:
   - Tier 0: Generated files (ignore)
   - Tier 1: Controllers/services (strict)
   - Tier 2: Core domain (gradual)
   - Tier 3: Qt/UI (error code suppression)

### A-2: Architecture Concerns

1. **Manager Sprawl** (see P1-2 above):
   - Too many thin manager classes
   - Recommend feature-based grouping instead of concern-based

2. **Core importing UI patterns** (Minor):
   - Some `core/` modules import Qt types directly via `core/pyqt_imports.py`
   - This is acceptable for signals/QObject but should not import widgets

3. **Delegator Chain in MainWindow**:
   - `MainWindow` → `main_window_delegates/` (10 files) → `ApplicationService` → Managers
   - 3-4 levels of indirection for simple operations
   - Consider direct controller access from MainWindow

---

## Performance & Responsiveness

### P-1: Model Reset Patterns (Acceptable)

**Evidence:** Found 5 `beginResetModel()` calls:
- `custom_file_system_model.py:226`
- `results_table_model.py:88`
- `file_operations.py:47, 63`
- `column_manager.py:223`

**Assessment:** These are appropriate for batch operations. No O(N²) refresh patterns detected.

### P-2: Thread Pool Usage (Good)

**Evidence:**
- `ThreadPoolManager` with `SmartWorkerThread` provides managed background work
- `ParallelHashWorker` uses `ThreadPoolExecutor` for parallel file hashing
- Proper `QMutex` usage for thread safety

### P-3: Potential Performance Issues

1. **Large UI Resource File**:
   - `oncutf/ui/resources_rc.py` — 14.9MB (likely base64-encoded images)
   - Consider lazy loading or external asset loading

2. **Exception Handler Performance**:
   - 50+ `except Exception:` blocks may impact performance in hot paths
   - Consider specific exception types

---

## Testing & Tooling

### T-1: Test Coverage Structure (Good)

**Files:** 71 test files in `tests/`
**Configuration:** pytest with markers (`slow`, `integration`, `unit`, `gui`, `exiftool`, `local_only`)

**Key Test Files:**
- `test_rename_controller.py` (24KB)
- `test_metadata_validation_system.py` (20KB)
- `test_hash_manager.py` (18KB)
- `test_main_window_controller.py` (17KB)

### T-2: Test Gaps (Needs Review)

1. **No tests found for:**
   - `backup_store.py` (incomplete module)
   - `rename_graph/` modules (unimplemented)
   - Some UI delegates

2. **Recommended additions:**
   - Integration tests for full rename workflow
   - Edge case tests for path traversal safety
   - Performance regression tests for large file sets

### T-3: Tooling Configuration (Good)

- **ruff:** Comprehensive rule selection with sensible ignores
- **mypy:** Tiered configuration for gradual adoption
- **pytest-qt:** Configured for PyQt5 testing
- **pre-commit:** Configuration exists (`.pre-commit-config.yaml`)

---

## Security / Safety Issues

### S-1: Path Normalization (Good)

**Evidence:** `oncutf/utils/filesystem/path_normalizer.py` and `oncutf/core/database/path_store.py` normalize paths consistently.

### S-2: Rename Collision Handling (Good)

**Evidence:** 
- `pre_execution_validator.py` validates before rename
- `conflict_resolver.py` handles naming conflicts
- Undo capability via `rename_history_manager.py`

### S-3: Recommendations

1. **Explicit confirmation for destructive operations:**
   - Verify large batch renames prompt confirmation
   - Check that backup creation happens before irreversible changes

2. **Path traversal prevention:**
   - Audit that user-provided filenames cannot escape target directory
   - Validate `..` sequences in rename patterns

---

## Refactor Plan

### Phase 1: Quick Wins (Low Risk, 1-2 days)

| # | Task | Files | Risk | Validation |
|---|------|-------|------|------------|
| 1 | Add logging to bare `except Exception:` blocks | 50+ files | Low | `ruff check`, `pytest` |
| 2 | Complete or remove `backup_store.py` | 1 file | Low | `pytest tests/core/` |
| 3 | Update imports from deprecated shims | ~10 files | Low | `ruff check`, `pytest` |
| 4 | Clean up unused imports | Various | Low | `ruff check --select F401 --fix` |

### Phase 2: Medium Refactors (2-4 weeks)

| # | Task | Files | Risk | Validation |
|---|------|-------|------|------------|
| 1 | Consolidate hash workers | `core/hash/` | Medium | `pytest tests/test_hash*` |
| 2 | Merge file managers | `core/file/` | Medium | Integration tests |
| 3 | Flatten manager hierarchy in metadata | `core/metadata/` | Medium | `pytest tests/test_metadata*` |
| 4 | Complete or remove `rename_graph/` | 4+ files | Medium | Feature flag testing |

### Phase 3: Architectural Improvements (1-2 months)

| # | Task | Description | Risk |
|---|------|-------------|------|
| 1 | Flatten MainWindow delegate chain | Reduce 4-level indirection to 2 | High |
| 2 | Implement feature-based module grouping | Replace concern-based managers | High |
| 3 | Extract UI from core completely | Pure Python core, Qt adapter layer | High |
| 4 | Add performance monitoring | Track operation latency, cache hit rates | Low |

---

## Clarifying Questions

1. **`rename_graph/` Status:** Is this an active development branch or abandoned? Should it be removed or completed?

2. **`BackupStore` Priority:** Should the rename_history extraction happen now, or is this deferred to v2.0?

3. **Deprecated Shims Timeline:** When is v2.0 release planned? Should shims be removed now?

4. **Test Coverage Goals:** What coverage percentage is the target? Are there specific areas that must have 100% coverage?

5. **Performance Requirements:** Are there specific benchmarks (e.g., "1000 files should rename in < 5s")?

6. **Manager Consolidation Appetite:** Is reducing manager count a priority, or is current structure acceptable?

---

## Action List (Top 20)

| # | Priority | Title | Files | Risk | Validation |
|---|----------|-------|-------|------|------------|
| 1 | P0 | Complete `BackupStore` or remove | `core/database/backup_store.py` | Low | `pytest tests/core/` |
| 2 | P0 | Decide on `rename_graph/` fate | `core/rename_graph/`, `controllers/rename_graph_controller.py` | Medium | Feature flag test |
| 3 | P1 | Audit `except Exception:` blocks | 50+ files | Low | `ruff check`, `pytest` |
| 4 | P1 | Add tests for critical untested paths | `tests/` | Low | `pytest --cov` |
| 5 | P1 | Merge `hash_worker.py` and `parallel_hash_worker.py` | `core/hash/` | Medium | `pytest tests/test_hash*` |
| 6 | P1 | Remove deprecated shims (post-migration) | `ui/widgets/file_*_view.py`, `ui/behaviors/*_behavior.py` | Low | Import grep, `pytest` |
| 7 | P1 | Clarify `HashService` vs `HashManager` | `services/hash_service.py`, `core/hash/hash_manager.py` | Low | API review |
| 8 | P2 | Consolidate file managers | `core/file/load_manager.py`, `validation_manager.py`, `operations_manager.py` | Medium | Integration tests |
| 9 | P2 | Consolidate metadata managers | `core/metadata/*.py` (7 managers) | Medium | `pytest tests/test_metadata*` |
| 10 | P2 | Add docstrings to undocumented functions | Various | Low | `pydocstyle` |
| 11 | P2 | Reduce `ui_managers/` count | 7 files → 3-4 | Medium | UI regression tests |
| 12 | P2 | Split large modules (>500 lines) | `shutdown_coordinator.py`, `rename_controller.py` | Medium | `pytest`, manual test |
| 13 | P2 | Add type hints to remaining untyped code | Various | Low | `mypy` |
| 14 | P2 | Flatten MainWindow delegate indirection | `ui/main_window_delegates/` | High | Manual UI testing |
| 15 | P2 | Implement lazy loading for `resources_rc.py` | `ui/resources_rc.py` | Medium | Startup time measurement |
| 16 | P2 | Add performance benchmarks | New file | Low | CI integration |
| 17 | P2 | Document architecture decisions | `docs/architecture.md` | Low | Review |
| 18 | P2 | Add path traversal validation tests | `tests/` | Low | Security review |
| 19 | P2 | Review backup/undo coverage | `core/rename/rename_history_manager.py` | Medium | Manual test |
| 20 | P2 | Consider async/await for I/O operations | `core/metadata/`, `core/hash/` | High | Performance testing |

---

## Validation Commands

```bash
# Lint checks
ruff check oncutf/ --statistics

# Type checking (tiered)
mypy oncutf/

# Run tests
pytest tests/ -v --tb=short

# Coverage report
pytest tests/ --cov=oncutf --cov-report=html

# Find unused imports
ruff check --select F401 oncutf/

# Find deprecated usage
grep -rn "DEPRECATED\|@deprecated" oncutf/

# Find bare exception handlers
grep -rn "except Exception:$" oncutf/
```

---

*End of Audit Report*
