# Refactoring & Optimization Plan - 2025-12-09

**Date:** 2025-12-09
**Status:** DRAFT
**Author:** Antigravity (Google Deepmind)

## 1. Executive Summary

This document outlines a comprehensive plan to refactor the `oncutf` codebase. The primary goals are to improve **performance**, enhance **code clarity**, and reduce **GUI errors**. The codebase currently exhibits symptoms of rapid organic growth, with several "god objects" and a flat directory structure in `core/` that hinders maintainability.

## 2. Structural Refactoring

### 2.1 Reorganize `core/` Package
The `core/` directory contains over 60 files, mixing low-level services, UI managers, and business logic.
**Action Plan:**
- Create `core/services/` for background services (e.g., `backup_manager.py`, `database_manager.py`).
- Create `core/ui/` for UI-related managers (e.g., `ui_manager.py`, `theme_manager.py`).
- Create `core/data/` for data handling (e.g., `file_store.py`, `selection_store.py`).
- Create `core/initialization/` for startup logic (e.g., `initialization_*.py`).

### 2.2 Split "God Classes"
Several files are excessively large and violate the Single Responsibility Principle.
- **`core/unified_metadata_manager.py` (88KB)**: This likely handles too many metadata aspects.
    - *Plan*: Split into `MetadataReader`, `MetadataWriter`, and `MetadataCacheService`.
- **`widgets/metadata_tree_view.py` (85KB)**: A massive UI component.
    - *Plan*: Extract internal widgets/delegates into separate files. Move data formatting logic to a valid model class.
- **`core/event_handler_manager.py` (65KB)**: Centralized event handling is good, but 65KB suggests it's handling too many specific events.
    - *Plan*: Use a pub/sub mechanism or split into domain-specific handlers (e.g., `FileEventHandlers`, `UIEventHandlers`).
- **`utils/theme_engine.py` (61KB)**:
    - *Plan*: Extract distinct theme strategies or palette definitions into `style/` or `core/ui/theme/`.

## 3. Performance Optimization

### 3.1 ExifTool Optimization
- **Verify Batching**: Ensure `ExifToolWrapper` effectively batches requests to minimize process overhead.
- **Stay-Open Mode**: Confirm usage of `-stay_open` argument for persistent processes (referenced in README, verify implementation details).
- **Parallel Processing**: Review `parallel_metadata_loader.py` to ensure it's not over-saturating I/O or CPU, causing UI freezes.

### 3.2 Caching Strategy
- **`advanced_cache_manager.py` & `persistent_metadata_cache.py`**:
    - Review cache invalidation logic. Stale cache is a common source of bugs.
    - Implement an in-memory L1 cache for frequently accessed items (icons, thumbnails) if not already present.

### 3.3 GUI Responsiveness
- **Thread Safety**: Audit `main_window.py` and `widgets/` for long-running operations on the main thread.
- **Signal Debouncing**: Ensure high-frequency signals (like scroll events or bulk file updates) are debounced to prevent UI lag.

## 4. Code Quality & Cleanliness

### 4.1 Type Hinting
- There are many files that likely lack strict type hints (inferred from `type: ignore` usage in `main.py`).
- **Plan**: Enforce strict type checking in `core/` newly refactored modules.

### 4.2 Error Handling & GUI Stability
- **Global Error Boundary**: Implement a `sys.excepthook` that catches unhandled exceptions and logs them nicely/shows a non-intrusive notification instead of crashing.
- **Defensive Widget Programming**: In `widgets/`, ensure that accessing data (e.g., from `FileItem`) always handles `None` or missing keys gracefully.

## 5. Implementation Roadmap

1.  **Phase 1: Housekeeping (Days 1-2)**
    - Reorganize directory structure (Move files).
    - Update imports.
    - Run existing tests to ensure no regressions.

2.  **Phase 2: Core Refactoring (Days 3-5)**
    - Split `unified_metadata_manager.py`.
    - Split `event_handler_manager.py`.

3.  **Phase 3: GUI Optimization (Days 6-8)**
    - Refactor `metadata_tree_view.py`.
    - Implement error boundaries.

4.  **Phase 4: Performance Tuning (Days 9-10)**
    - Profile `ExifTool` usage.
    - Optimize cache.

## 6. Metrics for Success
- **Startup Time**: < 2 seconds.
- **Memory Usage**: < 500MB for 10k files.
- **Crash Rate**: 0 unhandled exceptions during standard workflow.
- **Code checks**: `mypy` passing on strict mode for `core/`.
